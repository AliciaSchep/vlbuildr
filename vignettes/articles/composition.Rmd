---
title: "View Composition"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette covers how multiple charts can be combined using `vlbuildr`. For an introduction to making individual charts see the [introduction vignette](https://vegawidget.github.io/vlbuildr/articles/articles/introduction.html).

Sub-plots or 'views' can be combined in a number of ways. Layering assembles views into the same plot. Facetting splits views based on a column of data with the same encodings per view. Repeating splits views based on what field to use as one or two of the encodings. Concatenation combines arbitrary views together.  
## Layering

Layering assembles views into the same plot. A single view can only have one 'mark', so layering is how a plot can be made with multiple marks. Those marks can have different encodings or the same encodings.

### vl_layer

Two charts can be layered via `vl_layer`. Additional modifications can then be made to the resulting layered chart, although there are some limitations to the kinds of modifications that can be made to layered charts versus single view charts.  

```{r}
library(vlbuildr)

points_plot <- vl_chart() %>%
  vl_encode_x(field = "IMDB_Rating", type = "quantitative") %>%
  vl_encode_y(type = "quantitative", aggregate = "count") %>%
  vl_bin_x(maxbins=10) %>%
  vl_mark_bar()
  
avg_plot <- vl_chart() %>%
  vl_encode_x(field = "IMDB_Rating", type = "quantitative", aggregate = "mean") %>%
  vl_encode_color(value = "red") %>%
  vl_encode_size(value = 5) %>%
  vl_mark_rule()

vl_layer(points_plot, avg_plot) %>%
  vl_add_data_url("https://vega.github.io/vega-editor/app/data/movies.json")
```

In this case the data is added afterwards. That can help make sure the data isn't duplicated, and helps keep the size of the spec smaller. Note that layers can have different data, too, in which case the data would get added to each chart first before layering.

### The `+` operator

Layering can also be performed by using the `+` operator.

```{r}
(points_plot + avg_plot) %>%
  vl_add_data_url("https://vega.github.io/vega-editor/app/data/movies.json")
```

## Facet

Facetting splits up your data into different subplots based on a field in the data. This can be done across rows and/or columns.  Facets can get added in two ways: via `vl_facet_` functions or as encodings, eg `vl_encode_row`.

In terms of which option to use, they have slightly different options in terms of the parameters that can be given, but often are interchangeable.

### Facets as encoding

This example splits the data between rows based on the country of origin.

```{r}
vl_chart() %>%
  vl_add_data(url = "https://vega.github.io/vega-editor/app/data/cars.json") %>%
  vl_mark_bar() %>%
  vl_encode_x(field = "Horsepower", type = "quantitative") %>%
  vl_bin_x(maxbins = 15) %>%
  vl_encode_y(aggregate = "count", type = "quantitative") %>%
  vl_encode_row(field = "Origin", type = "nominal")
```

### Adding facets with facet functions

The following does the same as above, except via the `vl_facet_row` function.

```{r}
vl_chart() %>%
  vl_add_data(url = "https://vega.github.io/vega-editor/app/data/cars.json") %>%
  vl_mark_bar() %>%
  vl_encode_x(field = "Horsepower", type = "quantitative") %>%
  vl_bin_x(maxbins = 15) %>%
  vl_encode_y(aggregate = "count", type = "quantitative") %>%
  vl_facet_row(field = "Origin", type = "nominal")
```

## Repeating

Adding a 'repeat' is similar in some ways to facetting, except the same data gets shown in each subplot. Instead, what changes between subplots is what field gets used in the encoding. 

To use 'repeat' one needs to both call a `vl_repeat_*` function (where `*` is `wrap`, `row`, or `column`) with the field names to use, and specify the `field` for an encoding as `repeat:*` with the matching value of `*`.For example:

```{r}
vl_chart() %>%
  vl_add_data(url = "https://vega.github.io/vega-editor/app/data/cars.json") %>%
  vl_mark_bar() %>%
  vl_encode_x(field = "repeat:wrap", type = "quantitative", bin = TRUE) %>%
  vl_encode_y(aggregate = "count", type = "quantitative") %>%
  vl_encode_color(field = "Origin", type = "nominal") %>%
  vl_repeat_wrap("Horsepower", "Miles_per_Gallon", "Acceleration", "Displacement")
```

Alternatively a longer specification for the field can be used:

```{r}
vl_chart() %>%
  vl_add_data(url = "https://vega.github.io/vega-editor/app/data/cars.json") %>%
  vl_mark_bar() %>%
  vl_encode_x(field = list(`repeat` = "repeat"), type = "quantitative", bin = TRUE) %>%
  vl_encode_y(aggregate = "count", type = "quantitative") %>%
  vl_encode_color(field = "Origin", type = "nominal") %>%
  vl_repeat_wrap("Horsepower", "Miles_per_Gallon", "Acceleration", "Displacement")
```

## Concatenation

Different charts can be concatenated together via `vl_concat`, `vl_hconcat`, or `vl_vconcat` to concatenate in wrapping fashion (with number of columns set by `columns` arguments), horizontally, or vertically.  Data can be set for each individual view (and can then be different) or can be set for the concatenated version.

```{r}
bar_chart <- vl_chart() %>%
  vl_mark_bar() %>%
  vl_encode_x(field = "date:O", timeUnit = "month") %>%
  vl_encode_y(field = "precipitation:Q", aggregate = "mean")

point_chart <- vl_chart() %>%
  vl_mark_point() %>%
  vl_encode_x(field = "temp_min:Q", bin = TRUE) %>%
  vl_encode_y(field = "temp_max:Q", bin = TRUE) %>%
  vl_encode_size(aggregate = "count", type = "quantitative")
  
vl_hconcat(bar_chart, point_chart) %>% 
  vl_add_data(url = "https://vega.github.io/vega-lite/data/weather.csv") %>%
  vl_filter("datum.location === 'Seattle'")
```

Concatenation can also be done via the `|` or `&` operators, to do horizontal or vertical concatenation respectively.  

```{r}
(bar_chart | point_chart) %>% 
  vl_add_data(url = "https://vega.github.io/vega-lite/data/weather.csv") %>%
  vl_filter("datum.location === 'Seattle'")
```

```{r}
(bar_chart & point_chart) %>% 
  vl_add_data(url = "https://vega.github.io/vega-lite/data/weather.csv") %>%
  vl_filter("datum.location === 'Seattle'")
```
